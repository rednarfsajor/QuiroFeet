@model List<Analisis.BD.Ventas>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Lista de Ventas";
}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="sales-wrapper">

    <!-- Encabezado -->
    <div class="sales-header">
        <div class="header-left">
            <h1><i class="bi bi-cart-check"></i> Historial de Ventas</h1>
            <p>Visualiza, filtra y gestiona las ventas registradas en el sistema.</p>
        </div>

        <div class="header-right">
            <a href="@Url.Action("RegisterSale", "Ventas")" class="btn-top btn-add">
                <i class="bi bi-cart-plus"></i> Registrar venta
            </a>
            <a href="@Url.Action("Sales", "Ventas")" class="btn-top btn-back">
                <i class="bi bi-arrow-left-circle"></i> Volver al módulo de ventas
            </a>
        </div>
    </div>

    <!-- Controles de filtro/búsqueda -->
    <div class="sales-filters">
        <div class="filter-buttons">
            <button type="button" class="filter-btn active" data-filter="todas">Todas</button>
            <button type="button" class="filter-btn" data-filter="activas">Solo activas</button>
            <button type="button" class="filter-btn" data-filter="anuladas">Solo anuladas</button>
        </div>

        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text"
                   id="searchBox"
                   placeholder="Buscar por # de venta o nombre de cliente..." />
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
        <table class="sales-table">
            <thead>
                <tr>
                    <th># Venta</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Detalle</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th style="width:170px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Count > 0)
                {
                    foreach (var sale in Model)
                    {
                        var isAnulado = sale.Estado != null && sale.Estado.ToLower() == "anulado";
                        var rowId = "row-" + sale.id;
                        var estadoClase = isAnulado ? "row-anulado" : "row-activo";

                        <tr id="@rowId"
                            class="@estadoClase"
                            data-estado="@(isAnulado ? "anulado" : "activo")"
                            data-venta="@sale.id"
                            data-cliente="@(sale.Clientes != null ? sale.Clientes.nombre : "")">
                            <td>
                                <strong>@sale.id</strong>
                                <div class="estado-pill @(isAnulado ? "pill-anulado" : "pill-activo")">
                                    @(isAnulado ? "Anulado" : "Activo")
                                </div>
                            </td>
                            <td>@(sale.Clientes != null ? sale.Clientes.nombre : "Sin cliente")</td>
                            <td>@(sale.servicio == "True" ? "Servicio" : "Producto")</td>
                            <td>@sale.detalle</td>
                            <td>₡@string.Format("{0:N2}", sale.monto)</td>
                            <td>@(sale.fecha?.ToString("dd/MM/yyyy HH:mm") ?? "Sin fecha")</td>
                            <td id="acciones-@sale.id" class="actions-cell">
                                <a href="@Url.Action("Details", "Recibos", new { id = sale.id })"
                                   class="btn-table btn-details">
                                    <i class="bi bi-eye"></i> Detalles
                                </a>

                                @if (!isAnulado)
                                {
                                    <button type="button"
                                            class="btn-table btn-cancel"
                                            data-id="@sale.id">
                                        <i class="bi bi-x-circle"></i> Anular
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="bi bi-info-circle"></i>
                            No se encontraron ventas registradas.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // ============= FILTROS POR ESTADO =============
            const filterButtons = document.querySelectorAll(".filter-btn");
            const rows = document.querySelectorAll(".sales-table tbody tr");

            filterButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    const filter = this.getAttribute("data-filter");

                    filterButtons.forEach(b => b.classList.remove("active"));
                    this.classList.add("active");

                    rows.forEach(row => {
                        const estado = row.getAttribute("data-estado"); // 'activo' o 'anulado'
                        if (!estado) return;

                        row.style.display = ""; // reset

                        if (filter === "activas" && estado !== "activo") {
                            row.style.display = "none";
                        }
                        if (filter === "anuladas" && estado !== "anulado") {
                            row.style.display = "none";
                        }
                    });

                    // Aplica también el filtro de texto actual
                    aplicarFiltroTexto();
                });
            });

            // ============= BÚSQUEDA =============
            const searchBox = document.getElementById("searchBox");

            function aplicarFiltroTexto() {
                const texto = (searchBox.value || "").toLowerCase();
                const filtroActivo = document.querySelector(".filter-btn.active")?.getAttribute("data-filter") || "todas";

                rows.forEach(row => {
                    const estado = row.getAttribute("data-estado");
                    if (!estado) return;

                    // Primero respetamos el filtro de estado
                    let visiblePorEstado = true;
                    if (filtroActivo === "activas" && estado !== "activo") visiblePorEstado = false;
                    if (filtroActivo === "anuladas" && estado !== "anulado") visiblePorEstado = false;

                    if (!visiblePorEstado) {
                        row.style.display = "none";
                        return;
                    }

                    // Luego aplicamos búsqueda por venta/cliente
                    const venta = (row.getAttribute("data-venta") || "").toLowerCase();
                    const cliente = (row.getAttribute("data-cliente") || "").toLowerCase();

                    if (texto === "" || venta.includes(texto) || cliente.includes(texto)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            }

            if (searchBox) {
                searchBox.addEventListener("keyup", aplicarFiltroTexto);
            }

            // ============= ANULAR VENTA (SweetAlert + AJAX) =============
            const botonesAnular = document.querySelectorAll(".btn-cancel");

            botonesAnular.forEach(b => {
                b.addEventListener("click", function () {
                    const id = this.getAttribute("data-id");

                    Swal.fire({
                        title: "¿Anular venta?",
                        text: "La venta será marcada como anulada en el historial.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#234449",
                        cancelButtonColor: "#aaa",
                        confirmButtonText: "Sí, anular",
                        cancelButtonText: "Cancelar"
                    }).then(result => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: '/Recibos/Anular/' + id, // Endpoint actual
                                type: 'POST',
                                success: function (data) {
                                    if (data && data.success) {

                                        // Actualizar visualmente la fila
                                        const row = document.getElementById("row-" + id);
                                        if (row) {
                                            row.setAttribute("data-estado", "anulado");
                                            row.classList.remove("row-activo");
                                            row.classList.add("row-anulado");

                                            const estadoPill = row.querySelector(".estado-pill");
                                            if (estadoPill) {
                                                estadoPill.textContent = "Anulado";
                                                estadoPill.classList.remove("pill-activo");
                                                estadoPill.classList.add("pill-anulado");
                                            }

                                            const acciones = document.getElementById("acciones-" + id);
                                            if (acciones) {
                                                acciones.innerHTML =
                                                    '<a href="/Recibos/Details/' + id + '" class="btn-table btn-details">' +
                                                    '<i class="bi bi-eye"></i> Detalles</a>';
                                            }
                                        }

                                        Swal.fire("Listo", "La venta fue anulada correctamente.", "success");
                                    } else {
                                        Swal.fire("Error", "No se pudo anular la venta.", "error");
                                    }
                                },
                                error: function () {
                                    Swal.fire("Error", "Ocurrió un error al intentar anular la venta.", "error");
                                }
                            });
                        }
                    });
                });
            });
        });
    </script>
}

<style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f4f6f9;
    }

    .sales-wrapper {
        max-width: 1100px;
        margin: 60px auto;
        background: #ffffff;
        padding: 40px 35px;
        border-radius: 18px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
    }

    /* Header */
    .sales-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .header-left h1 {
        margin: 0;
        font-size: 2rem;
        color: #234449;
        font-weight: 700;
    }

    .header-left p {
        margin: 4px 0 0;
        color: #6c757d;
    }

    .header-right {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-top {
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #ffffff;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-add {
        background: #3e77f8;
    }

        .btn-add:hover {
            background: #234449;
        }

    .btn-back {
        background: #6c757d;
    }

        .btn-back:hover {
            background: #4f585f;
        }

    /* Filtros */
    .sales-filters {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        margin: 20px 0 10px;
    }

    .filter-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid #d0d7df;
        background: #ffffff;
        color: #234449;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
    }

        .filter-btn.active {
            background: #234449;
            color: #ffffff;
            border-color: #234449;
        }

    .search-box {
        flex: 1;
        max-width: 320px;
        background: #f1f3f5;
        border-radius: 999px;
        padding: 6px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .search-box i {
            color: #6c757d;
        }

        .search-box input {
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
            font-size: 0.9rem;
        }

    /* Tabla */
    .table-responsive {
        width: 100%;
        overflow-x: auto;
        margin-top: 10px;
    }

    .sales-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
    }

        .sales-table th,
        .sales-table td {
            padding: 11px 10px;
            text-align: center;
            border-bottom: 1px solid #e6e6e6;
        }

        .sales-table thead th {
            background: #234449;
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .sales-table tbody tr:hover td {
            background: #f3f7ff;
        }

    .row-anulado {
        background-color: #fff0f0;
    }

    .row-activo {
        background-color: #ffffff;
    }

    .estado-pill {
        margin-top: 4px;
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .pill-activo {
        background: #e3f7ea;
        color: #1f7a42;
    }

    .pill-anulado {
        background: #fde0e0;
        color: #a12323;
    }

    .actions-cell {
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .btn-table {
        padding: 6px 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #ffffff;
        font-weight: 600;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-details {
        background-color: #17a2b8;
    }

        .btn-details:hover {
            background-color: #138496;
        }

    .btn-cancel {
        background-color: #dc3545;
    }

        .btn-cancel:hover {
            background-color: #c82333;
        }

    .no-data {
        padding: 18px;
        font-weight: 600;
        color: #a94442;
        background: #fff3f3;
    }
</style>
