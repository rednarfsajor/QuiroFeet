@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">

    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h2 class="mb-0 h5"> <i class="fas fa-truck me-2"></i> @ViewBag.Title </h2>
            <div>

                <a href="@Url.Action("RegistrarProveedor", "Proveedores")" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i> Nuevo Proveedor
                </a>
            </div>
        </div>
        <div class="card-body">
            
            <div id="alertaMensajes" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
                <span id="mensajeTexto"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered table-sm" id="tablaProveedores">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Contacto</th>
                            <th>Teléfono</th>
                            <th>Correo Electrónico</th>
                            <th>Identificación Fiscal</th> 
                            <th class="text-center" style="width: 12%;">Acciones</th> 
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaProveedores">
                      
                        <tr>
                            <td colspan="6" class="text-center" id="filaLoading">
                                
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                Cargando proveedores...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div> 
    </div> 

</div> 


<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h1 class="modal-title fs-5" id="confirmarEliminarModalLabel"> <i class="fas fa-exclamation-triangle me-2"></i> Confirmar Eliminación</h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar a este proveedor? Esta acción no se puede deshacer.
                <br><strong id="nombreEntidadEliminar"></strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarEliminar"> <i class="fas fa-trash-alt me-1"></i> Eliminar </button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        
        const baseUrl = '@Url.Content("~/")';
        const proveedoresApiUrl = baseUrl + 'api/proveedores'; 
        let proveedorIdParaEliminar = null;

        
        function cargarProveedores() {
            const cuerpoTabla = $('#cuerpoTablaProveedores');
            const filaLoading = $('#filaLoading');
            filaLoading.show();
            cuerpoTabla.empty().append(filaLoading);

            $.ajax({
                url: proveedoresApiUrl, 
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    filaLoading.hide();
                    cuerpoTabla.empty();

                    if (data && data.length > 0) {
                        $.each(data, function (index, proveedor) {
                         
                            let fila = `
                                <tr>
                                    <td>${proveedor.nombre || 'N/A'}</td>
                                    <td>${proveedor.nombreContacto || 'N/A'}</td> 
                                    <td>${proveedor.telefono || 'N/A'}</td>
                                    <td>${proveedor.correoElectronico || 'N/A'}</td>
                                    <td>${proveedor.identificacionFiscal || 'N/A'}</td> 
                                    <td class="text-center">
                                        <a href="${baseUrl}Proveedores/EditarProveedor?id=${proveedor.id}" class="btn btn-warning btn-sm me-1" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="${baseUrl}Proveedores/DetallesProveedor?id=${proveedor.id}" class="btn btn-info btn-sm text-white me-1" title="Detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                       
                                        <button type="button" class="btn btn-danger btn-sm btn-eliminar" data-id="${proveedor.id}" data-nombre="${proveedor.nombre || 'Proveedor'}" title="Eliminar">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>`;
                            cuerpoTabla.append(fila);
                        });
                    } else {
                        cuerpoTabla.append('<tr><td colspan="6" class="text-center">No hay proveedores registrados.</td></tr>'); 
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    filaLoading.hide();
                    console.error("Error al cargar proveedores:", textStatus, errorThrown, jqXHR.responseText);
                    cuerpoTabla.empty().append('<tr><td colspan="6" class="text-center text-danger">Error al cargar los datos. Intente de nuevo más tarde.</td></tr>'); 
                }
            });
        }

       
        $('#tablaProveedores').on('click', '.btn-eliminar', function () {
            proveedorIdParaEliminar = $(this).data('id');
            const nombreProveedor = $(this).data('nombre');
            $('#nombreEntidadEliminar').text(nombreProveedor); 
            $('#confirmarEliminarModal').modal('show');
        });

        $('#btnConfirmarEliminar').on('click', function () {
            if (proveedorIdParaEliminar) {
                 const urlEliminar = `${proveedoresApiUrl}/${proveedorIdParaEliminar}`; 

                 $.ajax({
                    url: urlEliminar,
                    method: 'DELETE',
                    success: function (response) {
                        $('#confirmarEliminarModal').modal('hide');
                         mostrarAlerta('Proveedor eliminado correctamente.', 'success');
                        cargarProveedores(); 
                        proveedorIdParaEliminar = null;
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                         $('#confirmarEliminarModal').modal('hide');
                         console.error("Error al eliminar proveedor:", textStatus, errorThrown, jqXHR.responseText);
                         mostrarAlerta('Error al eliminar el proveedor. ' + (jqXHR.responseJSON?.message || errorThrown), 'danger');
                         proveedorIdParaEliminar = null;
                    }
                });
            }
        });

       
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alerta = $('#alertaMensajes');
            const texto = $('#mensajeTexto');
            texto.text(mensaje);
            alerta.removeClass('alert-success alert-danger alert-warning alert-info').addClass(`alert-${tipo}`);
            alerta.show();
            setTimeout(() => { alerta.fadeOut(); }, 5000);
        }

       
        $(document).ready(function () {
            
            const successMessage = sessionStorage.getItem('successMessage');
            if (successMessage) {
                mostrarAlerta(successMessage, 'success');
                sessionStorage.removeItem('successMessage');
            }

            cargarProveedores(); 
        });

    </script>
}